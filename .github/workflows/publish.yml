name: Publish Python package

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - master

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish:
    runs-on: [self-hosted, Linux]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect package directory
        id: detect
        run: |
          if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            PKG_DIR='.'
          elif [ -f "sdk/python/setup.py" ] || [ -f "sdk/python/pyproject.toml" ]; then
            PKG_DIR='sdk/python'
          else
            echo "ERROR: cannot find setup.py or pyproject.toml in repo root or sdk/python"
            exit 1
          fi
          echo "PKG_DIR=$PKG_DIR" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build "$PKG_DIR"

      - name: Configure .pypirc for GitHub Packages and PyPI
        run: |
          PYPIRC_DIR="${HOME:-$GITHUB_WORKSPACE}"
          echo "Using pypirc directory: $PYPIRC_DIR"
          mkdir -p "$PYPIRC_DIR" || { echo "Cannot create $PYPIRC_DIR"; exit 1; }
          PYPIRC_PATH="$PYPIRC_DIR/.pypirc"
          {
            echo "[distutils]"
            echo "index-servers ="
            echo "    github"
            echo "    pypi"
            echo ""
            echo "[github]"
            echo "repository: https://upload.pypi.github.com/legacy/"
            echo "username: $GITHUB_ACTOR"
            echo "password: $GITHUB_TOKEN"
            echo ""
            echo "[pypi]"
            echo "repository: https://upload.pypi.org/legacy/"
            echo "username: __token__"
            echo "password: $PYPI_API_TOKEN"
          } > "$PYPIRC_PATH"
          echo "Wrote $PYPIRC_PATH"
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: ${{ startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/master' }}
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m twine upload --repository github $PKG_DIR/dist/*

      - name: Publish to PyPI (optional)
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "$PYPI_API_TOKEN" ]; then
            echo "PYPI_API_TOKEN not set â€” skipping PyPI publish"
            exit 0
          fi
          python -m twine upload --repository pypi $PKG_DIR/dist/*
